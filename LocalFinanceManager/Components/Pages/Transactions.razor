@page "/transactions"
@using LocalFinanceManager.DTOs
@using LocalFinanceManager.Data.Repositories
@using LocalFinanceManager.Services
@inject ITransactionRepository TransactionRepository
@inject IAccountRepository AccountRepository
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Transacties</PageTitle>

<h1>Transacties
    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" @onclick="() => showShortcutHelp = true"
        title="Toetsenbord sneltoetsen">
        <i class="bi bi-question-circle"></i>
    </button>
</h1>

<!-- Quick Filters -->
<QuickFilters CurrentFilters="filterState" OnFiltersChanged="OnFiltersChanged" />

<div class="row mb-3">
    <div class="col-md-6">
        <label for="accountFilter" class="form-label">Filter op rekening:</label>
        <select id="accountFilter" class="form-select" @bind="selectedAccountIdString" @bind:after="OnAccountChanged">
            <option value="">Alle rekeningen</option>
            @foreach (var account in accounts)
            {
                <option value="@account.Id">@account.Label</option>
            }
        </select>
    </div>
</div>

<div class="mb-3">
    <a href="/transactions/import" class="btn btn-primary">
        <i class="bi bi-upload"></i> Importeer transacties
    </a>
</div>

@if (loading)
{
    <TransactionListSkeleton RowCount="10" />
}
else if (filteredTransactions.Count == 0)
{
    <div class="alert alert-info">
        Geen transacties gevonden. @(selectedAccountId.HasValue ? "Selecteer een andere rekening of " : "")
        <a href="/transactions/import">Importeer transacties</a> om te beginnen.
    </div>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" class="form-check-input" @onchange="ToggleSelectAll"
                        checked="@(selectedTransactionIds.Count == filteredTransactions.Count && filteredTransactions.Any())"
                        title="Selecteer alles" />
                </th>
                <th>Status</th>
                <th>Datum</th>
                <th>Beschrijving</th>
                <th>Tegenpartij</th>
                <th>Bedrag</th>
                <th>Toewijzing</th>
                <th>Acties</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var transaction in filteredTransactions)
            {
                <tr class="@(selectedTransactionIds.Contains(transaction.Id) ? "table-primary" : "")">
                    <td>
                        <input type="checkbox" class="form-check-input"
                            checked="@selectedTransactionIds.Contains(transaction.Id)"
                            @onchange="() => ToggleSelectTransaction(transaction.Id)" />
                    </td>
                    <td>
                        @if (!transaction.IsAssigned)
                        {
                            <span class="badge bg-warning text-dark" title="Transactie niet toegewezen aan categorie"
                                aria-label="Niet toegewezen">
                                <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
                                <span class="visually-hidden">Niet toegewezen</span>
                            </span>
                        }
                        else if (transaction.Splits != null && transaction.Splits.Count > 1)
                        {
                            <span class="badge bg-info" title="Gesplitste transactie" aria-label="Gesplitst">
                                <i class="bi bi-distribute-vertical" aria-hidden="true"></i>
                                <span class="visually-hidden">Gesplitst</span>
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-success" title="Transactie toegewezen" aria-label="Toegewezen">
                                <i class="bi bi-check-circle" aria-hidden="true"></i>
                                <span class="visually-hidden">Toegewezen</span>
                            </span>
                        }
                    </td>
                    <td>@transaction.Date.ToString("dd-MM-yyyy")</td>
                    <td>@transaction.Description</td>
                    <td>@transaction.Counterparty</td>
                    <td class="@(transaction.Amount >= 0 ? "text-success" : "text-danger")">
                        @transaction.Amount.ToString("C2")
                    </td>
                    <td>
                        @if (transaction.IsAssigned && transaction.Splits != null)
                        {
                            @if (transaction.Splits.Count > 1)
                            {
                                <span class="badge bg-info text-dark me-1"
                                    title="@string.Join(", ", transaction.Splits.Select(s => $"{s.BudgetLineName}: {s.Amount:C2}"))">
                                    @transaction.Splits.Count splits
                                </span>
                            }
                            else
                            {
                                @foreach (var split in transaction.Splits)
                                {
                                    <span class="badge bg-info text-dark me-1">@split.BudgetLineName</span>
                                }
                            }
                        }
                        else if (!transaction.IsAssigned)
                        {
                            <MLSuggestionBadge TransactionId="@transaction.Id"
                                OnSuggestionAccepted="@(async () => await OnSuggestionAccepted(transaction.Id))" />
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => OpenAssignModal(transaction)"
                            title="@(transaction.IsAssigned ? "Wijzig toewijzing" : "Wijs toe")">
                            <i class="bi bi-pencil"></i> @(transaction.IsAssigned ? "Wijzig" : "Toewijzen")
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-1" @onclick="() => OpenSplitEditor(transaction)"
                            title="Splits transactie">
                            <i class="bi bi-distribute-vertical"></i> Split
                        </button>
                        @if (transaction.IsAssigned)
                        {
                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => OpenAuditTrail(transaction.Id)"
                                title="Bekijk toewijzingsgeschiedenis" aria-label="Bekijk toewijzingsgeschiedenis">
                                <i class="bi bi-clock-history" aria-hidden="true"></i>
                            </button>
                        }
                    </td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <th></th>
                <th colspan="4" class="text-end">Totaal (gefilterd):</th>
                <th class="@(filteredTotalAmount >= 0 ? "text-success" : "text-danger")">@filteredTotalAmount.ToString("C2")
                </th>
                <th colspan="2"></th>
            </tr>
        </tfoot>
    </table>

    <p class="text-muted">
        @filteredTransactions.Count van @transactionDtos.Count transactie(s) weergegeven
        @if (unassignedCount > 0)
        {
            <span class="text-warning">(@unassignedCount niet toegewezen)</span>
        }
    </p>
}

<TransactionAssignModal Transaction="@selectedTransaction" IsVisible="@showAssignModal" OnClose="@CloseAssignModal"
    OnAssignmentSuccess="@OnAssignmentSuccess" />

<SplitEditor Transaction="@splitTransaction" IsVisible="@showSplitEditor" OnClose="@CloseSplitEditor"
    OnSplitSaved="@OnSplitSaved" />

<BulkAssignModal TransactionIds="@selectedTransactionIds" BudgetPlanId="@GetBulkBudgetPlanId()"
    IsVisible="@showBulkAssignModal" OnClose="@CloseBulkAssignModal" OnBulkAssigned="@OnBulkAssigned" />

<AssignmentAuditTrail TransactionId="@auditTransactionId" IsVisible="@showAuditTrail" OnClose="@CloseAuditTrail" />

<ShortcutHelp IsVisible="@showShortcutHelp" OnClose="@(() => showShortcutHelp = false)" />

@if (selectedTransactionIds.Any())
{
    <div class="position-fixed bottom-0 start-50 translate-middle-x mb-3" style="z-index: 1050;">
        <div class="card shadow-lg">
            <div class="card-body p-3">
                <div class="d-flex align-items-center gap-3">
                    <span class="badge bg-primary fs-6">@selectedTransactionIds.Count geselecteerd</span>
                    <button class="btn btn-sm btn-primary" @onclick="OpenBulkAssignModal">
                        <i class="bi bi-check-all"></i> Bulk toewijzen
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ClearSelection">
                        <i class="bi bi-x-circle"></i> Deselecteer alles
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<TransactionDto> transactionDtos = new();
    private List<TransactionDto> filteredTransactions = new();
    private List<LocalFinanceManager.Models.Account> accounts = new();
    private Guid? selectedAccountId = null;
    private string selectedAccountIdString = "";
    private bool loading = true;
    private decimal filteredTotalAmount = 0;
    private int unassignedCount = 0;
    private FilterState filterState = new();

    private bool showAssignModal = false;
    private TransactionDto? selectedTransaction = null;

    private bool showSplitEditor = false;
    private TransactionDto? splitTransaction = null;

    private bool showBulkAssignModal = false;
    private List<Guid> selectedTransactionIds = new();

    private bool showAuditTrail = false;
    private Guid? auditTransactionId = null;

    private bool showShortcutHelp = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadAccountsAsync();
        await LoadTransactionsAsync();
    }

    private async Task LoadAccountsAsync()
    {
        accounts = await AccountRepository.GetActiveAsync();
    }

    private async Task LoadTransactionsAsync()
    {
        loading = true;

        List<LocalFinanceManager.Models.Transaction> transactions;
        if (selectedAccountId.HasValue)
        {
            transactions = await TransactionRepository.GetByAccountIdWithSplitsAsync(selectedAccountId.Value);
        }
        else
        {
            transactions = await TransactionRepository.GetAllWithSplitsAsync();
        }

        // Convert to DTOs
        transactionDtos = transactions.Select(t => new TransactionDto
        {
            Id = t.Id,
            Amount = t.Amount,
            Date = t.Date,
            Description = t.Description,
            Counterparty = t.Counterparty,
            AccountId = t.AccountId,
            ExternalId = t.ExternalId,
            SourceFileName = t.SourceFileName,
            ImportedAt = t.ImportedAt,
            RowVersion = t.RowVersion,
            AccountBudgetPlanId = t.Account?.CurrentBudgetPlanId,
            Splits = t.AssignedParts?.Select(s => new TransactionSplitDetailDto
            {
                Id = s.Id,
                BudgetLineId = s.BudgetLineId,
                BudgetLineName = s.BudgetLine?.Category?.Name ?? "Onbekend",
                Amount = s.Amount,
                Note = s.Note
            }).ToList()
        }).OrderByDescending(t => t.Date).ToList();

        ApplyFilters();
        loading = false;
    }

    private void ApplyFilters()
    {
        var query = transactionDtos.AsEnumerable();

        // Apply assignment status filter
        query = filterState.AssignmentStatus switch
        {
            "assigned" => query.Where(t => t.IsAssigned),
            "unassigned" => query.Where(t => !t.IsAssigned),
            "split" => query.Where(t => t.Splits != null && t.Splits.Count > 1),
            "auto-applied" => query, // TODO: Add auto-applied tracking
            _ => query
        };

        // Apply date range filter
        if (filterState.DateRange != "all")
        {
            var now = DateTime.Now;
            var startDate = filterState.DateRange switch
            {
                "last7" => now.AddDays(-7),
                "last30" => now.AddDays(-30),
                "last90" => now.AddDays(-90),
                "custom" => filterState.CustomStartDate ?? DateTime.MinValue,
                _ => DateTime.MinValue
            };

            var endDate = filterState.DateRange == "custom"
            ? filterState.CustomEndDate ?? DateTime.MaxValue
            : DateTime.MaxValue;

            query = query.Where(t => t.Date >= startDate && t.Date <= endDate);
        }

        // Apply amount range filter
        if (filterState.MinAmount.HasValue)
        {
            query = query.Where(t => Math.Abs(t.Amount) >= filterState.MinAmount.Value);
        }
        if (filterState.MaxAmount.HasValue)
        {
            query = query.Where(t => Math.Abs(t.Amount) <= filterState.MaxAmount.Value);
        }

        // Apply account filter (if set via QuickFilters)
        if (filterState.SelectedAccountId.HasValue)
        {
            query = query.Where(t => t.AccountId == filterState.SelectedAccountId.Value);
        }

        filteredTransactions = query.OrderByDescending(t => t.Date).ToList();
        filteredTotalAmount = filteredTransactions.Sum(t => t.Amount);
        unassignedCount = transactionDtos.Count(t => !t.IsAssigned);
    }

    private void OnFiltersChanged(FilterState newFilters)
    {
        filterState = newFilters;
        ApplyFilters();
        StateHasChanged();
    }

    private async Task OnAccountChanged()
    {
        selectedAccountId = string.IsNullOrEmpty(selectedAccountIdString)
        ? null
        : Guid.Parse(selectedAccountIdString);

        await LoadTransactionsAsync();
    }

    private void OpenAssignModal(TransactionDto transaction)
    {
        selectedTransaction = transaction;
        showAssignModal = true;
    }

    private void CloseAssignModal()
    {
        showAssignModal = false;
        selectedTransaction = null;
    }

    private async Task OnAssignmentSuccess()
    {
        // Reload transactions to reflect the assignment
        await LoadTransactionsAsync();
        StateHasChanged();
    }

    private void OpenAuditTrail(Guid transactionId)
    {
        auditTransactionId = transactionId;
        showAuditTrail = true;
    }

    private void CloseAuditTrail()
    {
        showAuditTrail = false;
        auditTransactionId = null;
    }

    private void OpenSplitEditor(TransactionDto transaction)
    {
        splitTransaction = transaction;
        showSplitEditor = true;
    }

    private void CloseSplitEditor()
    {
        showSplitEditor = false;
        splitTransaction = null;
    }

    private async Task OnSplitSaved()
    {
        await LoadTransactionsAsync();
        StateHasChanged();
    }

    private void ToggleSelectAll(ChangeEventArgs e)
    {
        if (e.Value is bool isChecked && isChecked)
        {
            selectedTransactionIds = filteredTransactions.Select(t => t.Id).ToList();
        }
        else
        {
            selectedTransactionIds.Clear();
        }
        StateHasChanged();
    }

    private void ToggleSelectTransaction(Guid transactionId)
    {
        if (selectedTransactionIds.Contains(transactionId))
        {
            selectedTransactionIds.Remove(transactionId);
        }
        else
        {
            selectedTransactionIds.Add(transactionId);
        }
        StateHasChanged();
    }

    private void ClearSelection()
    {
        selectedTransactionIds.Clear();
        StateHasChanged();
    }

    private void OpenBulkAssignModal()
    {
        showBulkAssignModal = true;
    }

    private void CloseBulkAssignModal()
    {
        showBulkAssignModal = false;
    }

    private async Task OnBulkAssigned()
    {
        await LoadTransactionsAsync();
        selectedTransactionIds.Clear();
        StateHasChanged();
    }

    private Guid? GetBulkBudgetPlanId()
    {
        // Determine the budget plan ID for the current bulk selection.
        // Validate that all selected transactions share the same account/budget plan.
        if (!selectedTransactionIds.Any())
        {
            return null;
        }

        var selectedTransactions = transactionDtos
        .Where(t => selectedTransactionIds.Contains(t.Id))
        .ToList();

        if (!selectedTransactions.Any())
        {
            return null;
        }

        var distinctBudgetPlanIds = selectedTransactions
        .Select(t => t.AccountBudgetPlanId)
        .Distinct()
        .ToList();

        // Only return a budget plan ID if all selected transactions share the same one
        return distinctBudgetPlanIds.Count == 1 ? distinctBudgetPlanIds[0] : null;
    }

    private async Task OnSuggestionAccepted(Guid transactionId)
    {
        // Reload transactions to reflect the accepted suggestion
        await LoadTransactionsAsync();
        StateHasChanged();
    }
}