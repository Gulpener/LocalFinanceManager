@page "/transactions/import"
@rendermode InteractiveServer
@using LocalFinanceManager.DTOs
@using LocalFinanceManager.Data.Repositories
@using LocalFinanceManager.Services.Import
@using System.Text
@inject IAccountRepository AccountRepository
@inject ITransactionRepository TransactionRepository
@inject ImportService ImportService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>Importeer transacties</PageTitle>

<h1>Importeer transacties</h1>

<div class="row">
    <div class="col-md-8">
        @if (currentStep == ImportStep.Upload)
        {
            <div class="card">
                <div class="card-header">
                    <h5>Stap 1: Upload bestand</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="accountSelect" class="form-label">Rekening *</label>
                        <select id="accountSelect" class="form-select" value="@selectedAccountId"
                            @onchange="OnAccountChanged">
                            <option value="">Selecteer een rekening...</option>
                            @foreach (var account in accounts)
                            {
                                <option value="@account.Id.ToString()">@account.Label (@account.Currency)</option>
                            }
                        </select>
                        <div class="form-text">@accounts.Count rekening(en) beschikbaar</div>
                    </div>

                    <div class="mb-3">
                        <label for="fileFormat" class="form-label">Bestandsformaat *</label>
                        <select id="fileFormat" class="form-select" @bind="fileFormat">
                            <option value="csv">CSV</option>
                            <option value="json">JSON</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="fileInput" class="form-label">Bestand *</label>
                        <InputFile id="fileInput" class="form-control" OnChange="HandleFileSelection" accept=".csv,.json" />
                        <div class="form-text">
                            Maximale bestandsgrootte: 100 MB
                            @if (selectedFile != null)
                            {
                                <br />
                                <strong>Geselecteerd:</strong>

                                <span>@selectedFile.Name
                                    (@(selectedFile.Size.ToString("N0")) bytes)</span>
                            }
                        </div>
                    </div>

                    @if (errorMessage != null)
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                    }

                    <button class="btn btn-primary" @onclick="PreviewImport"
                        disabled="@(selectedFile == null || string.IsNullOrEmpty(selectedAccountId) || loading)">
                        @if (loading)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span> Laden...</span>
                        }
                        else
                        {
                            <span>Volgende: Preview</span>
                        }
                    </button>
                    <a href="/transactions" class="btn btn-secondary">Annuleren</a>
                </div>
            </div>
        }
        else if (currentStep == ImportStep.Preview)
        {
            <div class="card">
                <div class="card-header">
                    <h5>Stap 2: Controleer kolom-mapping</h5>
                </div>
                <div class="card-body">
                    @if (preview != null)
                    {
                        <div class="mb-3">
                            <h6>Gevonden kolommen in bestand:</h6>
                            @foreach (var col in preview.AvailableColumns)
                            {
                                <span class="badge bg-secondary me-2" style="margin: 3px;">@col</span>
                            }
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Datum kolom *</label>
                            <select class="form-select" @bind="preview.SuggestedMapping.DateColumn">
                                @foreach (var col in preview.AvailableColumns)
                                {
                                    <option value="@col">@col</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Bedrag kolom *</label>
                            <select class="form-select" @bind="preview.SuggestedMapping.AmountColumn">
                                @foreach (var col in preview.AvailableColumns)
                                {
                                    <option value="@col">@col</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Beschrijving kolom</label>
                            <select class="form-select" @bind="preview.SuggestedMapping.DescriptionColumn">
                                <option value="">Geen</option>
                                @foreach (var col in preview.AvailableColumns)
                                {
                                    <option value="@col">@col</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Tegenpartij kolom</label>
                            <select class="form-select" @bind="preview.SuggestedMapping.CounterpartyColumn">
                                <option value="">Geen</option>
                                @foreach (var col in preview.AvailableColumns)
                                {
                                    <option value="@col">@col</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Externe ID kolom</label>
                            <select class="form-select" @bind="preview.SuggestedMapping.ExternalIdColumn">
                                <option value="">Geen</option>
                                @foreach (var col in preview.AvailableColumns)
                                {
                                    <option value="@col">@col</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <h6>Voorbeeld transacties (eerste @preview.SampleTransactions.Count van @preview.TotalRows):</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Datum</th>
                                            <th>Bedrag</th>
                                            <th>Beschrijving</th>
                                            <th>Tegenpartij</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var tx in preview.SampleTransactions)
                                        {
                                            <tr>
                                                <td>@tx.Date.ToString("dd-MM-yyyy")</td>
                                                <td class="@(tx.Amount >= 0 ? "text-success" : "text-danger")">
                                                    @tx.Amount.ToString("C2")</td>
                                                <td>@tx.Description</td>
                                                <td>@tx.Counterparty</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Deduplicatie strategie</label>
                            <select class="form-select" @bind="deduplicationStrategy">
                                <option value="exact">Exact (Datum + Bedrag + Externe ID)</option>
                                <option value="fuzzy">Fuzzy (Beschrijving similariteit + Bedrag)</option>
                                <option value="none">Geen (importeer alles)</option>
                            </select>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="skipErrors" @bind="skipErrors" />
                            <label class="form-check-label" for="skipErrors">
                                Sla rijen met fouten over (partial import)
                            </label>
                        </div>
                    }

                    <button class="btn btn-success" @onclick="ExecuteImport" disabled="@loading">
                        @if (loading)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span> Importeren...</span>
                        }
                        else
                        {
                            <span>Importeer @preview?.TotalRows transacties</span>
                        }
                    </button>
                    <button class="btn btn-secondary" @onclick="GoBackToUpload" disabled="@loading">Terug</button>
                </div>
            </div>
        }
        else if (currentStep == ImportStep.Result)
        {
            <div class="card">
                <div class="card-header">
                    <h5>Import resultaat</h5>
                </div>
                <div class="card-body">
                    @if (importResult != null)
                    {
                        @if (importResult.Success)
                        {
                            <div class="alert alert-success">
                                <h6>✓ Import succesvol!</h6>
                                <ul>
                                    <li>@importResult.ImportedCount transactie(s) geïmporteerd</li>
                                    <li>@importResult.DuplicateCount duplicaten overgeslagen</li>
                                    @if (importResult.SkippedCount > 0)
                                    {
                                        <li>@importResult.SkippedCount rij(en) overgeslagen vanwege fouten</li>
                                    }
                                </ul>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-danger">
                                <h6>✗ Import mislukt</h6>
                                <p>@importResult.Message</p>
                            </div>
                        }

                        @if (importResult.Errors.Any())
                        {
                            <div class="alert alert-warning">
                                <h6>Fouten (@importResult.Errors.Count):</h6>
                                <ul style="max-height: 200px; overflow-y: auto;">
                                    @foreach (var error in importResult.Errors.Take(20))
                                    {
                                        <li>Regel @error.LineNumber (@error.FieldName): @error.ErrorMessage</li>
                                    }
                                    @if (importResult.Errors.Count > 20)
                                    {
                                        <li><em>... en @(importResult.Errors.Count - 20) meer</em></li>
                                    }
                                </ul>
                            </div>
                        }
                    }

                    <a href="/transactions" class="btn btn-primary">Ga naar transacties</a>
                    <button class="btn btn-secondary" @onclick="StartNewImport">Nieuwe import</button>
                </div>
            </div>
        }
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6>Import stappen</h6>
            </div>
            <div class="card-body">
                <ol class="list-group list-group-numbered">
                    <li class="list-group-item @(currentStep == ImportStep.Upload ? "active" : "")">Upload bestand</li>
                    <li class="list-group-item @(currentStep == ImportStep.Preview ? "active" : "")">Controleer mapping
                    </li>
                    <li class="list-group-item @(currentStep == ImportStep.Result ? "active" : "")">Bekijk resultaat
                    </li>
                </ol>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6>Tips</h6>
            </div>
            <div class="card-body">
                <ul class="small">
                    <li>CSV bestand moet headers bevatten</li>
                    <li>Datum formaten: yyyy-MM-dd, dd-MM-yyyy, dd/MM/yyyy</li>
                    <li>Bedragen kunnen positief (inkomsten) of negatief (uitgaven) zijn</li>
                    <li>Externe ID helpt bij deduplicatie</li>
                    <li>Fuzzy matching gebruikt tekst similariteit (Jaccard)</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@code {
    private enum ImportStep
    {
        Upload,
        Preview,
        Result
    }

    private ImportStep currentStep = ImportStep.Upload;
    private List<LocalFinanceManager.Models.Account> accounts = new();
    private string selectedAccountId = "";
    private string fileFormat = "csv";
    private IBrowserFile? selectedFile;
    private string? errorMessage;
    private bool loading = false;
    private ImportPreviewDto? preview;
    private ImportResultDto? importResult;
    private string deduplicationStrategy = "exact";
    private bool skipErrors = true;
    private string? fileContentBase64;

    protected override async Task OnInitializedAsync()
    {
        accounts = await AccountRepository.GetActiveAsync();
    }

    private void OnAccountChanged(ChangeEventArgs e)
    {
        selectedAccountId = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    private void HandleFileSelection(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        errorMessage = null;
        StateHasChanged();
    }

    private async Task PreviewImport()
    {
        if (selectedFile == null) return;

        loading = true;
        errorMessage = null;

        try
        {
            // Read file content
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024); // 100 MB
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var fileBytes = ms.ToArray();
            var fileContent = Encoding.UTF8.GetString(fileBytes);
            fileContentBase64 = Convert.ToBase64String(fileBytes);

            // Call preview service directly
            preview = await ImportService.PreviewImportAsync(fileContent, fileFormat);

            if (preview.Errors.Any())
            {
                errorMessage = $"Preview fouten: {string.Join(", ", preview.Errors.Select(e => e.ErrorMessage))}";
            }
            else
            {
                currentStep = ImportStep.Preview;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fout bij preview: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task ExecuteImport()
    {
        if (preview == null || string.IsNullOrEmpty(fileContentBase64)) return;

        loading = true;
        errorMessage = null;

        try
        {
            // Decode Base64 to file content
            var fileBytes = Convert.FromBase64String(fileContentBase64);
            var fileContent = Encoding.UTF8.GetString(fileBytes);

            // Create import request
            var request = new ImportTransactionsRequest
            {
                AccountId = Guid.Parse(selectedAccountId),
                FileFormat = fileFormat,
                FileContent = fileContentBase64,
                ColumnMapping = preview.SuggestedMapping,
                DeduplicationStrategy = deduplicationStrategy,
                SkipErrors = skipErrors,
                SourceFileName = selectedFile?.Name
            };

            // Call import service directly
            importResult = await ImportService.ImportTransactionsAsync(request, request.AccountId);
            currentStep = ImportStep.Result;
        }
        catch (Exception ex)
        {
            importResult = new ImportResultDto
            {
                Success = false,
                Message = $"Fout bij import: {ex.Message}"
            };
            currentStep = ImportStep.Result;
        }
        finally
        {
            loading = false;
        }
    }

    private void GoBackToUpload()
    {
        currentStep = ImportStep.Upload;
        preview = null;
    }

    private void StartNewImport()
    {
        currentStep = ImportStep.Upload;
        preview = null;
        importResult = null;
        selectedFile = null;
        fileContentBase64 = null;
        errorMessage = null;
    }
}