@page "/settings/auto-apply"
@using LocalFinanceManager.DTOs.ML
@using LocalFinanceManager.Data.Repositories
@using System.Net.Http.Json
@inject HttpClient Http
@inject IAccountRepository AccountRepository
@inject ICategoryRepository CategoryRepository
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Auto-Apply instellingen</PageTitle>

<Breadcrumb
    Items="@(new List<Breadcrumb.BreadcrumbItem> { new("Home", "/"), new("Instellingen"), new("Auto-Apply") })" />

<h1>Auto-Apply instellingen</h1>

<p class="lead">Configureer automatische toewijzing van transacties op basis van ML-suggesties.</p>

@if (_loading)
{
    <div class="text-center my-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Laden...</span>
        </div>
    </div>
}
else
{
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Algemene instellingen</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="enableAutoApply"
                                @bind="_settings.Enabled">
                            <label class="form-check-label" for="enableAutoApply">
                                <strong>Automatische toewijzing inschakelen</strong>
                            </label>
                        </div>
                        <small class="text-muted">
                            Wanneer ingeschakeld worden transacties automatisch toegewezen op basis van ML-suggesties
                            met hoge betrouwbaarheid.
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="confidenceThreshold" class="form-label">
                            Betrouwbaarheidsdrempel: <strong>@((_settings.MinimumConfidence * 100).ToString("F0"))%</strong>
                        </label>
                        <input type="range" class="form-range" id="confidenceThreshold" min="0.6" max="0.95" step="0.05"
                            @bind="_settings.MinimumConfidence" @bind:event="oninput">
                        <small class="text-muted d-block">
                            Hoger = nauwkeuriger maar minder automatische toewijzingen.
                            Aanbevolen: 75-85%
                        </small>
                        @if (_previewStats != null)
                        {
                            <div class="alert alert-info mt-2">
                                <i class="bi bi-info-circle"></i>
                                Op basis van de laatste 100 transacties zouden er <strong>@_previewStats</strong>
                                automatisch worden toegewezen met deze drempel.
                            </div>
                        }
                    </div>

                    <div class="mb-3">
                        <label for="intervalMinutes" class="form-label">
                            Uitvoerinterval (minuten)
                        </label>
                        <input type="number" class="form-control" id="intervalMinutes" @bind="_settings.IntervalMinutes"
                            min="5" max="1440">
                        <small class="text-muted">
                            Hoe vaak de auto-apply job moet worden uitgevoerd (standaard: 15 minuten)
                        </small>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Account selectie</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Selecteer welke rekeningen moeten worden gebruikt voor automatische toewijzing
                        (laat leeg voor alle rekeningen).</p>

                    @foreach (var account in _accounts)
                    {
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="account_@account.Id"
                                checked="@IsAccountSelected(account.Id)" @onchange="@(() => ToggleAccount(account.Id))">
                            <label class="form-check-label" for="account_@account.Id">
                                @account.Label
                            </label>
                        </div>
                    }
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Uitgesloten categorieën</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Selecteer categorieën die moeten worden uitgesloten van automatische toewijzing
                        (bijv. gevoelige categorieën zoals "Belastingen").</p>

                    @if (_categories.Any())
                    {
                        <div class="row">
                            @foreach (var category in _categories.OrderBy(c => c.Name))
                            {
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="category_@category.Id"
                                            checked="@IsCategoryExcluded(category.Id)"
                                            @onchange="@(() => ToggleExcludedCategory(category.Id))">
                                        <label class="form-check-label" for="category_@category.Id">
                                            @category.Name
                                        </label>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Geen categorieën beschikbaar.</p>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> @_errorMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(_successMessage))
            {
                <div class="alert alert-success" role="alert">
                    <i class="bi bi-check-circle"></i> @_successMessage
                </div>
            }

            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" @onclick="SaveSettings" disabled="@_saving">
                    @if (_saving)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    }
                    Instellingen opslaan
                </button>
                <button type="button" class="btn btn-outline-secondary" @onclick="LoadSettings">
                    Annuleren
                </button>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-light">
                <div class="card-header">
                    <h6 class="mb-0">ℹ️ Informatie</h6>
                </div>
                <div class="card-body">
                    <h6>Hoe werkt auto-apply?</h6>
                    <p class="small">
                        De auto-apply functie gebruikt machine learning om transacties automatisch
                        toe te wijzen aan categorieën. Alleen suggesties met een betrouwbaarheid
                        boven de ingestelde drempel worden toegepast.
                    </p>

                    <h6 class="mt-3">Betrouwbaarheidsdrempel</h6>
                    <ul class="small">
                        <li><strong>60-70%:</strong> Meer auto-toewijzingen, maar mogelijk minder nauwkeurig</li>
                        <li><strong>75-85%:</strong> Aanbevolen balans tussen volume en nauwkeurigheid</li>
                        <li><strong>90-95%:</strong> Zeer nauwkeurig, maar minder auto-toewijzingen</li>
                    </ul>

                    <h6 class="mt-3">Monitoring</h6>
                    <p class="small">
                        Bekijk de <a href="/settings/monitoring">monitoring dashboard</a> om de
                        prestaties van auto-apply te volgen en ongedaan gemaakte toewijzingen te bekijken.
                    </p>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private AutoApplySettingsDto _settings = new();
    private List<LocalFinanceManager.Models.Account> _accounts = new();
    private List<LocalFinanceManager.Models.Category> _categories = new();
    private bool _loading = true;
    private bool _saving = false;
    private string? _errorMessage;
    private string? _successMessage;
    private int? _previewStats;

    protected override async Task OnInitializedAsync()
    {
        await LoadAccounts();
        await LoadCategories();
        await LoadSettings();
        _loading = false;
    }

    private async Task LoadAccounts()
    {
        _accounts = await AccountRepository.GetActiveAsync();
    }

    private async Task LoadCategories()
    {
        _categories = await CategoryRepository.GetActiveAsync();
    }

    private async Task LoadSettings()
    {
        try
        {
            // Load settings from backend (or use defaults)
            var response = await Http.GetAsync("/api/automation/settings");

            if (response.IsSuccessStatusCode)
            {
                var settings = await response.Content.ReadFromJsonAsync<AutoApplySettingsDto>();
                if (settings != null)
                {
                    _settings = settings;
                }
            }
            else
            {
                // Use default settings
                _settings = new AutoApplySettingsDto
                {
                    Enabled = false,
                    MinimumConfidence = 0.8f,
                    IntervalMinutes = 15,
                    AccountIds = new List<Guid>(),
                    ExcludedCategoryIds = new List<Guid>()
                };
            }

            await LoadPreviewStats();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Fout bij laden van instellingen: {ex.Message}";
        }
    }

    private async Task LoadPreviewStats()
    {
        try
        {
            var response = await Http.GetAsync($"/api/automation/preview?confidence={_settings.MinimumConfidence}");
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<Dictionary<string, int>>();
                _previewStats = result?["estimatedAutoApplyCount"];
            }
        }
        catch
        {
            // Preview stats are optional, don't show error
        }
    }

    private async Task SaveSettings()
    {
        try
        {
            _saving = true;
            _errorMessage = null;
            _successMessage = null;

            var response = await Http.PostAsJsonAsync("/api/automation/settings", _settings);

            if (response.IsSuccessStatusCode)
            {
                _successMessage = "Instellingen succesvol opgeslagen!";
                await JS.InvokeVoidAsync("eval", @"
if (typeof window.showToast === 'function') {
window.showToast('Instellingen opgeslagen', 'success');
}
");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                _errorMessage = $"Fout bij opslaan: {errorContent}";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Fout bij opslaan van instellingen: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }

    private bool IsAccountSelected(Guid accountId)
    {
        // If no accounts are selected, all accounts are included
        if (_settings.AccountIds.Count == 0)
            return false;

        return _settings.AccountIds.Contains(accountId);
    }

    private void ToggleAccount(Guid accountId)
    {
        if (_settings.AccountIds.Contains(accountId))
        {
            _settings.AccountIds.Remove(accountId);
        }
        else
        {
            _settings.AccountIds.Add(accountId);
        }

        StateHasChanged();
    }

    private bool IsCategoryExcluded(Guid categoryId)
    {
        return _settings.ExcludedCategoryIds.Contains(categoryId);
    }

    private void ToggleExcludedCategory(Guid categoryId)
    {
        if (_settings.ExcludedCategoryIds.Contains(categoryId))
        {
            _settings.ExcludedCategoryIds.Remove(categoryId);
        }
        else
        {
            _settings.ExcludedCategoryIds.Add(categoryId);
        }

        StateHasChanged();
    }
}