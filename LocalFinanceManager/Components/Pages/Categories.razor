@page "/categories"
@using LocalFinanceManager.Services
@using LocalFinanceManager.DTOs
@inject CategoryService CategoryService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Categorieën</PageTitle>

<h1>Categorieën</h1>

<div class="mb-3">
    <a href="/categories/new" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Nieuwe Categorie
    </a>
</div>

@if (categories == null)
{
    <p><em>Categorieën laden...</em></p>
}
else if (!categories.Any())
{
    <div class="alert alert-info">
        <p>Geen categorieën gevonden. Maak uw eerste categorie aan om te beginnen!</p>
    </div>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Naam</th>
                <th>Acties</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var category in categories)
            {
                <tr>
                    <td>@category.Name</td>
                    <td>
                        <a href="/categories/@category.Id/edit" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil"></i> Bewerken
                        </a>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmArchive(category)">
                            <i class="bi bi-archive"></i> Archiveren
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<!-- Archive Confirmation Modal -->
@if (categoryToArchive != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bevestig Archivering</h5>
                    <button type="button" class="btn-close" @onclick="CancelArchive"></button>
                </div>
                <div class="modal-body">
                    <p>Weet u zeker dat u de categorie "<strong>@categoryToArchive.Name</strong>" wilt archiveren?</p>
                    <p class="text-muted">Gearchiveerde categorieën worden verborgen maar kunnen later worden hersteld.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelArchive">Annuleren</button>
                    <button type="button" class="btn btn-danger" @onclick="ArchiveCategory">Archiveren</button>
                </div>
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger mt-3">@errorMessage</div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success mt-3">@successMessage</div>
}

@code {
    private List<CategoryDto>? categories;
    private CategoryDto? categoryToArchive;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        try
        {
            categories = await CategoryService.GetAllActiveAsync();
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Fout bij laden van categorieën: {ex.Message}";
        }
    }

    private void ConfirmArchive(CategoryDto category)
    {
        categoryToArchive = category;
    }

    private void CancelArchive()
    {
        categoryToArchive = null;
    }

    private async Task ArchiveCategory()
    {
        if (categoryToArchive == null) return;

        try
        {
            var success = await CategoryService.ArchiveAsync(categoryToArchive.Id);
            if (success)
            {
                successMessage = $"Categorie '{categoryToArchive.Name}' is succesvol gearchiveerd.";
                categoryToArchive = null;
                await LoadCategories(); // Reload the list
                
                // Clear success message after 3 seconds
                await Task.Delay(3000);
                successMessage = null;
                StateHasChanged();
            }
            else
            {
                errorMessage = "Categorie niet gevonden.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fout bij archiveren van categorie: {ex.Message}";
        }
    }
}
