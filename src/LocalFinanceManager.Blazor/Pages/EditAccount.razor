@page "/accounts/{Id}/edit"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components
@inject LocalFinanceManager.Blazor.Services.AccountService AccountsApi

@code {
    [Parameter]
    public string Id { get; set; } = string.Empty;

    private EditDto? model;

    protected override async System.Threading.Tasks.Task OnParametersSetAsync()
    {
        var guid = Guid.Parse(Id);
        var dto = await AccountsApi.GetAsync(guid);
        if (dto != null)
        {
            model = new EditDto
            {
                Id = dto.Id,
                Label = dto.Label,
                Type = dto.Type.ToString(),
                Currency = dto.Currency,
                IBAN = dto.IBAN,
                StartingBalance = dto.StartingBalance,
                RowVersion = dto.RowVersion ?? Array.Empty<byte>()
            };
        }
    }

    async System.Threading.Tasks.Task Save()
    {
        if (model == null) return;
        var update = new LocalFinanceManager.Blazor.Models.UpdateAccountDto
        {
            Id = model.Id,
            Label = model.Label,
            Type = Enum.Parse<LocalFinanceManager.Blazor.Models.AccountType>(model.Type),
            Currency = model.Currency,
            IBAN = model.IBAN,
            StartingBalance = model.StartingBalance,
            RowVersion = model.RowVersion
        };
        var ok = await AccountsApi.UpdateAsync(model.Id, update);
        if (ok) NavigationManager.NavigateTo("/accounts");
    }

    [Inject]
    public NavigationManager NavigationManager { get; set; } = null!;

    public class EditDto
    {
        public Guid Id { get; set; }
        public string Label { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public string Currency { get; set; } = string.Empty;
        public string IBAN { get; set; } = string.Empty;
        public decimal StartingBalance { get; set; }
        public byte[] RowVersion { get; set; } = Array.Empty<byte>();
    }
}

<h3>Edit Account</h3>

@if (model == null) { <p>Loading...</p> }
else
{
    <div>
        <div>
            <label>Label</label>
            <input @bind="model.Label" />
        </div>
        <div>
            <label>IBAN</label>
            <input @bind="model.IBAN" />
        </div>
        <div>
            <label>Currency</label>
            <input @bind="model.Currency" />
        </div>
        <div>
            <label>Starting Balance</label>
            <input type="number" step="0.01" @bind="model.StartingBalance" />
        </div>
        <button @onclick="Save">Save</button>
    </div>
}
