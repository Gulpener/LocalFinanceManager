@page "/rules"
@using LocalFinanceManager.Domain.Entities
@inject LocalFinanceManager.Application.Interfaces.IRuleRepository RuleRepository
@inject LocalFinanceManager.Application.Interfaces.ICategoryRepository CategoryRepository
@inject LocalFinanceManager.Application.Interfaces.IEnvelopeRepository EnvelopeRepository
@inject IJSRuntime Js
@inject NavigationManager Nav

<h3>Rules</h3>

<button class="btn btn-primary mb-2" @onclick="CreateNew">Add Rule</button>

@if (rules == null)
{
    <p><em>Loading…</em></p>
}
else
{
    <table class="table table-sm">
        <thead>
            <tr>
                <th>Priority</th>
                <th>Match</th>
                <th>Pattern</th>
                <th>Target Category</th>
                <th>Target Envelope</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var r in rules)
            {
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-secondary me-1" @onclick="() => MoveUp(r)">▲</button>
                            <button class="btn btn-sm btn-outline-secondary me-2" @onclick="() => MoveDown(r)">▼</button>
                            @r.Priority
                        </div>
                    </td>
                    <td>@r.MatchType</td>
                    <td>@r.Pattern</td>
                    <td>@(CategoryNames.TryGetValue(r.TargetCategoryId ?? 0, out var cn) ? cn : "—")</td>
                    <td>@(EnvelopeNames.TryGetValue(r.TargetEnvelopeId ?? 0, out var en) ? en : "—")</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => Edit(r.Id)">Edit</button>
                        <button class="btn btn-sm btn-outline-danger me-1" @onclick="() => ConfirmDelete(r.Id)">Delete</button>
                        <button class="btn btn-sm btn-outline-info" @onclick="() => Preview(r.Id)">Preview</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Rule>? rules;
    private Dictionary<int, string> CategoryNames = new();
    private Dictionary<int, string> EnvelopeNames = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadRules();
    }

    private async Task LoadRules()
    {
        rules = (await RuleRepository.GetAllOrderedByPriorityAsync()).ToList();

        var catIds = rules.Where(r => r.TargetCategoryId.HasValue).Select(r => r.TargetCategoryId!.Value).Distinct().ToList();
        var envIds = rules.Where(r => r.TargetEnvelopeId.HasValue).Select(r => r.TargetEnvelopeId!.Value).Distinct().ToList();

        CategoryNames.Clear();
        EnvelopeNames.Clear();

        foreach (var id in catIds)
        {
            var c = await CategoryRepository.GetByIdAsync(id);
            if (c != null) CategoryNames[id] = c.Name ?? "";
        }

        foreach (var id in envIds)
        {
            var e = await EnvelopeRepository.GetByIdAsync(id);
            if (e != null) EnvelopeNames[id] = e.Name ?? "";
        }
    }

    private void CreateNew() => Nav.NavigateTo("/rules/new");
    private void Edit(int id) => Nav.NavigateTo($"/rules/edit/{id}");
    private void Preview(int id) => Nav.NavigateTo($"/rules/preview/{id}");

    private async Task ConfirmDelete(int id)
    {
        var ok = await Js.InvokeAsync<bool>("confirm", "Delete this rule? This action cannot be undone.");
        if (!ok) return;
        await RuleRepository.DeleteAsync(id);
        await LoadRules();
    }

    private async Task MoveUp(Rule rule)
    {
        var idx = rules!.IndexOf(rule);
        if (idx <= 0) return;
        var other = rules[idx - 1];
        var tmp = rule.Priority;
        rule.Priority = other.Priority;
        other.Priority = tmp;
        await RuleRepository.UpdateAsync(rule);
        await RuleRepository.UpdateAsync(other);
        await LoadRules();
    }

    private async Task MoveDown(Rule rule)
    {
        var idx = rules!.IndexOf(rule);
        if (idx < 0 || idx >= rules.Count - 1) return;
        var other = rules[idx + 1];
        var tmp = rule.Priority;
        rule.Priority = other.Priority;
        other.Priority = tmp;
        await RuleRepository.UpdateAsync(rule);
        await RuleRepository.UpdateAsync(other);
        await LoadRules();
    }
}