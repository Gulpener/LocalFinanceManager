@page "/rules/edit/{Id:int}"
@page "/rules/new"
@using LocalFinanceManager.Domain.Entities
@inject LocalFinanceManager.Application.Interfaces.IRuleRepository RuleRepository
@inject LocalFinanceManager.Application.Interfaces.ICategoryRepository CategoryRepository
@inject LocalFinanceManager.Application.Interfaces.IEnvelopeRepository EnvelopeRepository
@inject NavigationManager Nav

<h3>@(isNew ? "New Rule" : "Edit Rule")</h3>

@if (rule == null)
{
    <p><em>Loadingâ€¦</em></p>
}
else
{
    <div class="mb-3">
        <label>Match Type</label>
        <select class="form-select" @bind="rule.MatchType">
            <option value="contains">contains</option>
            <option value="regex">regex</option>
            <option value="iban">iban</option>
            <option value="exact">exact</option>
        </select>
    </div>

    <div class="mb-3">
        <label>Pattern</label>
        <input class="form-control" @bind="rule.Pattern" />
    </div>

    <div class="mb-3">
        <label>Target Category</label>
        <select class="form-select" @bind="rule.TargetCategoryId">
            <option value="">-- none --</option>
            @foreach (var c in categories)
            {
                <option value="@c.Id">@c.Name</option>
            }
        </select>
    </div>

    <div class="mb-3">
        <label>Target Envelope</label>
        <select class="form-select" @bind="rule.TargetEnvelopeId">
            <option value="">-- none --</option>
            @foreach (var e in envelopes)
            {
                <option value="@e.Id">@e.Name</option>
            }
        </select>
    </div>

    <div class="mb-3">
        <label>Priority</label>
        <input type="number" class="form-control" @bind="rule.Priority" />
    </div>

    <div class="mb-3">
        <label>Labels (comma separated)</label>
        <input class="form-control" @bind="labelsText" />
    </div>

    <button class="btn btn-primary me-2" @onclick="Save">Save</button>
    <button class="btn btn-secondary" @onclick="Cancel">Cancel</button>
}

@code {
    [Parameter] public int? Id { get; set; }
    private Rule? rule;
    private bool isNew => !Id.HasValue;
    private List<Category> categories = new();
    private List<Envelope> envelopes = new();
    private string labelsText = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        categories = (await CategoryRepository.GetAllAsync()).ToList();
        envelopes = (await EnvelopeRepository.GetAllAsync()).ToList();
        if (Id.HasValue)
        {
            rule = await RuleRepository.GetByIdAsync(Id.Value);
            labelsText = string.Join(',', rule?.AddLabels ?? new List<string>());
        }
        else
        {
            rule = new Rule { Priority = 100 };
        }
    }

    private async Task Save()
    {
        rule!.AddLabels = labelsText.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
        if (isNew)
        {
            await RuleRepository.AddAsync(rule);
        }
        else
        {
            await RuleRepository.UpdateAsync(rule);
        }
        Nav.NavigateTo("/rules");
    }

    private void Cancel() => Nav.NavigateTo("/rules");
}
