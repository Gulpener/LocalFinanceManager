@page "/transactions"
@using LocalFinanceManager.Application.Interfaces
@using LocalFinanceManager.Domain.Entities
@inject IAccountRepository AccountRepository
@inject ITransactionService TransactionService
@inject ICategoryRepository CategoryRepository
@rendermode InteractiveServer

<PageTitle>Transactions - LocalFinanceManager</PageTitle>

<h1>Transactions</h1>

<div class="mb-3">
    <label for="accountSelect" class="form-label">Select Account:</label>
    <select id="accountSelect" class="form-select" @onchange="OnAccountChanged">
        <option value="">-- Select an Account --</option>
        @foreach (var account in accounts)
        {
            <option value="@account.Id">@account.Name (@account.AccountType)</option>
        }
    </select>
</div>

@if (selectedAccountId.HasValue)
{
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="ShowAddForm">
            <i class="bi bi-plus-circle"></i> Add Transaction
        </button>
    </div>

    @if (showAddForm)
    {
        <div class="card mb-3">
            <div class="card-header">Add New Transaction</div>
            <div class="card-body">
                <EditForm Model="@newTransaction" OnValidSubmit="AddTransaction">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger" />

                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <InputDate class="form-control" @bind-Value="newTransaction.Date" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Amount</label>
                        <InputNumber class="form-control" @bind-Value="newTransaction.Amount" />
                        <small class="text-muted">Positive for income, negative for expenses</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <InputText class="form-control" @bind-Value="newTransaction.Description" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Counter Account (IBAN)</label>
                        <InputText class="form-control" @bind-Value="newTransaction.CounterAccount" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <InputSelect class="form-select" @bind-Value="newTransaction.CategoryId">
                            @foreach (var category in categories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        </InputSelect>
                    </div>

                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelAdd">Cancel</button>
                </EditForm>
            </div>
        </div>
    }

    @if (transactions == null)
    {
        <p><em>Loading transactions...</em></p>
    }
    else if (transactions.Count == 0)
    {
        <div class="alert alert-info">No transactions found for this account.</div>
    }
    else
    {
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Counter Account</th>
                    <th>Category</th>
                    <th class="text-end">Amount</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var transaction in transactions)
                {
                    <tr>
                        <td>@transaction.Date.ToString("yyyy-MM-dd")</td>
                        <td>@transaction.Description</td>
                        <td>@transaction.CounterAccount</td>
                        <td>@transaction.Category?.Name</td>
                        <td class="text-end @(transaction.Amount >= 0 ? "text-success" : "text-danger")">
                            @transaction.Amount.ToString("C")
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteTransaction(transaction.Id)">
                                Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    private IReadOnlyList<Account> accounts = new List<Account>();
    private IReadOnlyList<Category> categories = new List<Category>();
    private IReadOnlyList<Transaction>? transactions;
    private int? selectedAccountId;
    private bool showAddForm = false;
    private Transaction newTransaction = new();

    protected override async Task OnInitializedAsync()
    {
        accounts = await AccountRepository.GetAllAsync();
        categories = await CategoryRepository.GetAllAsync();

        // If there are no categories, create a default one
        if (categories.Count == 0)
        {
            var defaultCategory = new Category { Name = "Uncategorized", MonthlyBudget = 0 };
            await CategoryRepository.AddAsync(defaultCategory);
            categories = await CategoryRepository.GetAllAsync();
        }
    }

    private async Task OnAccountChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var accountId))
        {
            selectedAccountId = accountId;
            await LoadTransactions();
        }
        else
        {
            selectedAccountId = null;
            transactions = null;
        }
    }

    private async Task LoadTransactions()
    {
        if (selectedAccountId.HasValue)
        {
            transactions = await TransactionService.GetByAccountIdAsync(selectedAccountId.Value);
        }
    }

    private void ShowAddForm()
    {
        newTransaction = new Transaction
        {
            AccountId = selectedAccountId!.Value,
            Date = DateTime.Today,
            CategoryId = categories.FirstOrDefault()?.Id ?? 0
        };
        showAddForm = true;
    }

    private void CancelAdd()
    {
        showAddForm = false;
        newTransaction = new();
    }

    private async Task AddTransaction()
    {
        await TransactionService.AddAsync(newTransaction);
        showAddForm = false;
        newTransaction = new();
        await LoadTransactions();
    }

    private async Task DeleteTransaction(int id)
    {
        await TransactionService.DeleteAsync(id);
        await LoadTransactions();
    }
}
