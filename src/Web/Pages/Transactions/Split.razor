@page "/transactions/split/{ParentId:int}"
@using LocalFinanceManager.Domain.Entities
@inject LocalFinanceManager.Application.Interfaces.ITransactionService TransactionService
@inject LocalFinanceManager.Application.Interfaces.ICategoryRepository CategoryRepository
@inject LocalFinanceManager.Application.Interfaces.IEnvelopeRepository EnvelopeRepository
@inject NavigationManager NavigationManager

<h3>Split Transaction Editor</h3>

@if (isLoading)
{
    <p>Loading...</p>
}
else if (loadError is not null)
{
    <div class="alert alert-danger">@loadError</div>
}
else
{
    <div>
        <p><strong>Parent Transaction Id:</strong> @ParentId</p>
        <p><strong>Parent Amount:</strong> @ParentAmount</p>
        <p><strong>Sum of Splits:</strong> @Splits.Sum(s => s.Amount)</p>
        <p><strong>Remaining:</strong> @(ParentAmount - Splits.Sum(s => s.Amount))</p>
        @if (sumMismatch)
        {
            <div class="alert alert-warning">Sum of split amounts does not equal parent amount.</div>
        }

        <table class="table">
            <thead>
                <tr>
                    <th>Amount</th>
                    <th>Category</th>
                    <th>Envelope</th>
                    <th>Notes</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var split in Splits)
                {
                    <tr>
                        <td style="width:120px;">
                            <input type="number" step="0.01" class="form-control" @bind="split.Amount" />
                        </td>
                        <td>
                            <select class="form-select" @bind="split.CategoryId">
                                <option value="">-- None --</option>
                                @foreach (var c in Categories)
                                {
                                    <option value="@c.Id">@c.Name</option>
                                }
                            </select>
                        </td>
                        <td>
                            <select class="form-select" @bind="split.EnvelopeId">
                                <option value="">-- None --</option>
                                @foreach (var e in Envelopes)
                                {
                                    <option value="@e.Id">@e.Name</option>
                                }
                            </select>
                        </td>
                        <td>
                            <input type="text" class="form-control" @bind="split.Notes" />
                        </td>
                        <td>
                            <button class="btn btn-danger" @onclick="() => RemoveSplit(split)">Remove</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <button class="btn btn-secondary" @onclick="AddNewSplit">Add Split</button>
        <button class="btn btn-primary" @onclick="SaveAll" disabled="@(saveDisabled || sumMismatch)">Save All</button>
        <button class="btn btn-link" @onclick="() => NavigationManager.NavigateTo($"/transactions/{ParentId}")">Back</button>

        @if (saveError is not null)
        {
            <div class="alert alert-danger mt-2">@saveError</div>
        }
        @if (saveSuccess)
        {
            <div class="alert alert-success mt-2">Saved successfully.</div>
        }
    </div>
}

@code {
    [Parameter]
    public int ParentId { get; set; }

    private bool isLoading = true;
    private string? loadError;
    private decimal ParentAmount { get; set; }
    private List<TransactionSplit> Splits { get; set; } = new();
    private List<Category> Categories { get; set; } = new();
    private List<Envelope> Envelopes { get; set; } = new();
    private bool saveDisabled => Splits.Count == 0;
    private bool saveSuccess = false;
    private string? saveError;
    private bool sumMismatch => Splits.Sum(s => s.Amount) != ParentAmount;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var parent = await TransactionService.GetByIdAsync(ParentId);
            if (parent == null)
            {
                loadError = "Parent transaction not found.";
                return;
            }

            ParentAmount = parent.Amount;

            // Clone existing splits if any
            Splits = parent.Splits?.Select(s => new TransactionSplit
            {
                Id = s.Id,
                ParentTransactionId = s.ParentTransactionId,
                Amount = s.Amount,
                CategoryId = s.CategoryId,
                EnvelopeId = s.EnvelopeId,
                Notes = s.Notes
            }).ToList() ?? new List<TransactionSplit>();

            // Ensure ParentTransactionId is set
            foreach (var s in Splits)
            {
                s.ParentTransactionId = ParentId;
            }
            // Load categories and envelopes for selectors
            Categories = (await CategoryRepository.GetAllAsync()).ToList();
            Envelopes = (await EnvelopeRepository.GetAllAsync()).ToList();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void AddNewSplit()
    {
        Splits.Add(new TransactionSplit { ParentTransactionId = ParentId, Amount = 0m });
        saveSuccess = false;
    }

    private void RemoveSplit(TransactionSplit s)
    {
        Splits.Remove(s);
        saveSuccess = false;
    }

    private async Task SaveAll()
    {
        saveError = null;
        saveSuccess = false;

        try
        {
            // Ensure parent ids
            foreach (var s in Splits) s.ParentTransactionId = ParentId;

            await TransactionService.AddSplitsAsync(Splits);
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveError = ex.Message;
        }
    }
}
